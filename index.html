<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>MEU FINANCEIRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; margin:0; background:#f6f7fb; display:flex; min-height:100vh; color:#111827; text-transform:uppercase; }

/* Menu lateral */
nav { width:300px; background:#1e3a8a; color:white; padding:16px; }
nav h2 { margin:0 0 16px 0; font-size:18px; }
nav .userbox { background:rgba(255,255,255,0.12); padding:12px; border-radius:8px; margin-bottom:12px; }
nav .userbox label { display:block; margin-bottom:6px; font-size:12px; opacity:0.9; }
nav .userbox input { width:100%; padding:8px; border:none; border-radius:6px; text-transform:uppercase; }
nav .userbox .btn { margin-top:8px; width:100%; background:#2563eb; color:white; border:none; border-radius:6px; padding:8px; font-weight:600; cursor:pointer; }
nav button { display:block; width:100%; margin:8px 0; padding:10px; background:#2563eb; border:none; border-radius:6px; color:white; cursor:pointer; text-align:left; font-weight:600; }
nav button.active { background:#1e40af; }

/* Conteúdo */
.content { flex:1; padding:24px; }
h1 { margin:0 0 16px 0; }

/* KPIs */
.dashboard { display:grid; grid-template-columns: repeat(4,1fr); gap:12px; margin-bottom:16px; }
.card { background:#f9fafb; padding:12px; border-radius:8px; text-align:center; border:1px solid #e5e7eb; }
.card h3 { margin:0; font-size:14px; color:#555; }
.card p { margin:4px 0 0; font-size:18px; font-weight:bold; }
#kpiReceitas, #relTotalReceitas { color:#2563eb; }
#kpiDespesas, #relTotalDespesas { color:#ef4444; }
#kpiSaldo, #relSaldo { color:#16a34a; }

/* Seções */
.section { background:white; border-radius:8px; padding:12px; border:1px solid #e5e7eb; margin-top:12px; }

/* Inputs */
input, select { margin:6px 0; padding:10px; width:100%; border:1px solid #d1d5db; border-radius:8px; font-size:14px; background:#fff; }

/* Botões */
.btn { padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.btn.primary { background:#2563eb; color:white; }
.btn.warn { background:#facc15; color:#111; }
.btn.danger { background:#ef4444; color:white; }
.btn.success { background:#16a34a; color:white; }
.btn + .btn { margin-left:8px; }

/* Tabelas */
table { width:100%; border-collapse:collapse; margin-top:12px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
thead th { background:#f9fafb; color:#374151; }
th, td { padding:10px 12px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }

/* Chips de status */
.chip { padding:4px 10px; border-radius:999px; font-weight:600; font-size:12px; display:inline-block; }
.chip.pago { background:#dcfce7; color:#166534; }
.chip.avencer { background:#fde68a; color:#92400e; }
.chip.vencido { background:#fecaca; color:#b91c1c; }
.chip.pendente { background:#f3f4f6; color:#374151; }

/* Cores de linha */
.row-pago { background:#dcfce7; }
.row-avencer { background:#fde68a; }
.row-vencido { background:#fecaca; }
.row-pendente { background:#f3f4f6; }

/* Ações e páginas */
.actions { display:flex; gap:8px; }
.page { display:none; }
.page.active { display:block; }

/* Modal */
.modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; padding:16px; }
.modal { background:#fff; border-radius:12px; width:100%; max-width:420px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
.modal h2 { margin-top:0; }
.modal .actions { margin-top:12px; display:flex; justify-content:flex-end; gap:8px; }

/* Subtotais */
.subtotais { display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:8px; }
.subtotais .card p { font-size:16px; }
</style>
</head>
<body>
<nav>
  <h2>MEU FINANCEIRO</h2>
  <div class="userbox">
    <label for="userName">USUÁRIO DO SISTEMA</label>
    <input id="userName" placeholder="DIGITE SEU NOME" />
    <button class="btn" id="btnSalvarUser">ENTRAR / ALTERAR NOME</button>
    <span class="user-status" id="userSaved"></span>
  </div>
  <button data-page="dashboard" class="active">DASHBOARD</button>
  <button data-page="receitas">RECEITAS</button>
  <button data-page="despesas">DESPESAS</button>
  <button data-page="relatorios">RELATÓRIOS</button>
  <button data-page="categorias">CATEGORIAS</button>
  <button data-page="contas">CONTAS</button>
</nav>

<div class="content">
  <!-- DASHBOARD -->
  <div id="dashboard" class="page active">
    <h1>DASHBOARD</h1>
    <div class="dashboard">
      <div class="card"><h3>RECEITAS</h3><p id="kpiReceitas">R$ 0,00</p></div>
      <div class="card"><h3>DESPESAS</h3><p id="kpiDespesas">R$ 0,00</p></div>
      <div class="card"><h3>SALDO</h3><p id="kpiSaldo">R$ 0,00</p></div>
      <div class="card"><h3>RECORRENTES</h3><p id="kpiRecorrentes">0%</p></div>
    </div>

    <div class="section">
      <label for="periodoSelect"><b>TIPO DE VISUALIZAÇÃO:</b></label>
      <select id="periodoSelect">
        <option value="dia">DIA</option>
        <option value="semana">SEMANA</option>
        <option value="mes" selected>MÊS</option>
        <option value="ano">ANO</option>
        <option value="intervalo">PERÍODO ESPECÍFICO</option>
      </select>
      <div id="filtrosPeriodo" style="display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:8px;">
        <div>
          <label for="filtroData">DATA (DIA):</label>
          <input id="filtroData" type="date" />
        </div>
        <div>
          <label for="filtroSemanaInicio">SEMANA INÍCIO:</label>
          <input id="filtroSemanaInicio" type="date" />
        </div>
        <div>
          <label for="filtroSemanaFim">SEMANA FIM:</label>
          <input id="filtroSemanaFim" type="date" />
        </div>
        <div>
          <label for="filtroMes">MÊS:</label>
          <input id="filtroMes" type="month" />
        </div>
        <div>
          <label for="filtroAno">ANO:</label>
          <input id="filtroAno" type="number" min="1900" max="2100" />
        </div>
        <div>
          <label for="filtroIntervaloInicio">INÍCIO (PERÍODO):</label>
          <input id="filtroIntervaloInicio" type="date" />
        </div>
        <div>
          <label for="filtroIntervaloFim">FIM (PERÍODO):</label>
          <input id="filtroIntervaloFim" type="date" />
        </div>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button class="btn primary" id="btnPesquisarDashboard">PESQUISAR</button>
        <button class="btn warn" id="btnLimparDashboard">LIMPAR FILTRO</button>
      </div>
    </div>

    <div class="section">
      <h2 id="tituloContasDia">CONTAS DO DIA</h2>
      <table>
        <thead><tr><th>TIPO</th><th>DESCRIÇÃO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>DATA</th><th>STATUS</th></tr></thead>
        <tbody id="tbodyDia"></tbody>
        <tfoot><tr><th colspan="4">TOTAL DO DIA</th><th id="totalDia">R$ 0,00</th><th colspan="2"></th></tr></tfoot>
      </table>
    </div>

    <div class="section">
      <h2>RECEITAS DO PERÍODO</h2>
      <div class="subtotais">
        <div class="card"><h3>SUBTOTAL RECEITAS</h3><p id="subtotalReceitas">R$ 0,00</p></div>
      </div>
      <table>
        <thead><tr><th>DESCRIÇÃO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>DATA</th><th>STATUS</th></tr></thead>
        <tbody id="tbodyPeriodoReceitas"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>DESPESAS DO PERÍODO</h2>
      <div class="subtotais">
        <div class="card"><h3>SUBTOTAL DESPESAS</h3><p id="subtotalDespesas">R$ 0,00</p></div>
        <div class="card"><h3>TOTAL DO PERÍODO</h3><p id="totalPeriodo">R$ 0,00</p></div>
      </div>
      <table>
        <thead><tr><th>DESCRIÇÃO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>DATA</th><th>STATUS</th></tr></thead>
        <tbody id="tbodyPeriodoDespesas"></tbody>
      </table>
    </div>
  </div>

  <!-- RECEITAS -->
  <div id="receitas" class="page">
    <h1>RECEITAS</h1>
    <form id="formReceita">
      <input id="descReceita" placeholder="DESCRIÇÃO" required />
      <select id="catReceita"></select>
      <select id="contaReceita"></select>
      <input id="valorReceita" type="text" placeholder="EX.: 3.750,00" required />
      <input id="dataReceita" type="date" required />
      <select id="statusReceita">
        <option value="pendente">PENDENTE</option>
        <option value="recebido">RECEBIDO</option>
      </select>
      <input id="dataPagtoReceita" type="date" />
      <select id="recorrenteReceita">
        <option value="false">NÃO RECORRENTE</option>
        <option value="true">RECORRENTE</option>
      </select>
      <div>
        <button type="button" class="btn primary" id="btnSalvarReceita">SALVAR</button>
        <input type="hidden" id="editIndexReceita" />
      </div>
    </form>

    <table>
      <thead>
        <tr><th>DESCRIÇÃO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>DATA</th><th>STATUS</th><th>PAGTO</th><th>AÇÕES</th></tr>
      </thead>
      <tbody id="tbodyReceitas"></tbody>
    </table>
  </div>

  <!-- DESPESAS -->
  <div id="despesas" class="page">
    <h1>DESPESAS</h1>
    <form id="formDespesa">
      <input id="descDespesa" placeholder="DESCRIÇÃO" required />
      <select id="catDespesa"></select>
      <select id="contaDespesa"></select>
      <input id="valorDespesa" type="text" placeholder="EX.: 3.750,00" required />
      <input id="dataDespesa" type="date" required />
      <select id="statusDespesa">
        <option value="pendente">PENDENTE</option>
        <option value="pago">PAGO</option>
      </select>
      <input id="dataPagtoDespesa" type="date" />
      <select id="recorrenteDespesa">
        <option value="false">NÃO RECORRENTE</option>
        <option value="true">RECORRENTE</option>
      </select>
      <input id="boletoDespesa" type="file" accept=".pdf,.jpg,.png,.jpeg" />
      <div>
        <button type="button" class="btn primary" id="btnSalvarDespesa">SALVAR</button>
        <input type="hidden" id="editIndexDespesa" />
      </div>
    </form>

    <table>
      <thead>
        <tr><th>DESCRIÇÃO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>VENCIMENTO</th><th>STATUS</th><th>PAGTO</th><th>RECORRENTE</th><th>BOLETO</th><th>AÇÕES</th></tr>
      </thead>
      <tbody id="tbodyDespesas"></tbody>
    </table>
  </div>

  <!-- RELATÓRIOS -->
  <div id="relatorios" class="page">
    <h1>RELATÓRIOS</h1>
    <div class="section">
      <h2>RESUMO</h2>
      <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:8px;">
        <div class="card"><h3>TOTAL RECEITAS</h3><p id="relTotalReceitas">R$ 0,00</p></div>
        <div class="card"><h3>TOTAL DESPESAS</h3><p id="relTotalDespesas">R$ 0,00</p></div>
        <div class="card"><h3>SALDO</h3><p id="relSaldo">R$ 0,00</p></div>
      </div>
    </div>

    <div class="section">
      <h2>FILTROS</h2>
      <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:8px;">
        <div>
          <label>TIPO PERÍODO:</label>
          <select id="relPeriodoTipo">
            <option value="dia">DIA</option>
            <option value="mes" selected>MÊS</option>
            <option value="ano">ANO</option>
            <option value="intervalo">PERÍODO</option>
          </select>
        </div>
        <div><label>DIA:</label><input id="relDia" type="date" /></div>
        <div><label>MÊS:</label><input id="relMes" type="month" /></div>
        <div><label>ANO:</label><input id="relAno" type="number" min="1900" max="2100" /></div>
        <div><label>INÍCIO:</label><input id="relInicio" type="date" /></div>
        <div><label>FIM:</label><input id="relFim" type="date" /></div>
        <div>
          <label>CATEGORIA:</label>
          <select id="relCategoria"><option value="">TODAS</option></select>
        </div>
        <div>
          <label>TIPO DE DADO:</label>
          <select id="relTipoDado">
            <option value="todos" selected>TODOS</option>
            <option value="receitas">RECEITAS</option>
            <option value="despesas">DESPESAS</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px;">
        <button class="btn primary" id="btnGerarRelatorio">GERAR RELATÓRIO</button>
        <button class="btn success" id="btnExportarPDF">EXPORTAR PDF</button>
      </div>
    </div>

    <div class="section">
      <h2>RECEITAS</h2>
      <table>
        <thead><tr><th>DESCRIÇÃO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>DATA</th><th>STATUS</th></tr></thead>
        <tbody id="relReceitasBody"></tbody>
        <tfoot><tr><th colspan="3">TOTAL</th><th id="relReceitasTotal">R$ 0,00</th><th colspan="2"></th></tr></tfoot>
      </table>
    </div>

    <div class="section">
      <h2>DESPESAS</h2>
      <table>
        <thead><tr><th>DESCRIÇÃO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>DATA</th><th>STATUS</th></tr></thead>
        <tbody id="relDespesasBody"></tbody>
        <tfoot><tr><th colspan="3">TOTAL</th><th id="relDespesasTotal">R$ 0,00</th><th colspan="2"></th></tr></tfoot>
      </table>
    </div>

    <div class="section">
      <h2>ANÁLISE POR CATEGORIA</h2>
      <table>
        <thead><tr><th>CATEGORIA</th><th>TOTAL</th></tr></thead>
        <tbody id="relAnaliseCatBody"></tbody>
      </table>
    </div>
  </div>

  <!-- CATEGORIAS -->
  <div id="categorias" class="page">
    <h1>CATEGORIAS</h1>
    <form id="formCategoria">
      <input id="nomeCategoria" placeholder="NOVA CATEGORIA (EX.: ENERGIA, INTERNET)" required />
      <div>
        <button type="button" class="btn primary" id="btnSalvarCategoria">SALVAR CATEGORIA</button>
        <input type="hidden" id="editIndexCategoria" />
      </div>
    </form>
    <table>
      <thead><tr><th>CATEGORIA</th><th>AÇÕES</th></tr></thead>
      <tbody id="tbodyCategorias"></tbody>
    </table>
  </div>

  <!-- CONTAS (bancos/IFs) -->
  <div id="contas" class="page">
    <h1>CONTAS</h1>
    <form id="formConta">
      <input id="nomeConta" placeholder="NOVA CONTA/BANCO (EX.: ITAÚ, NUBANK, CAIXA)" required />
      <div>
        <button type="button" class="btn primary" id="btnSalvarConta">SALVAR CONTA</button>
        <input type="hidden" id="editIndexConta" />
      </div>
    </form>
    <table>
      <thead><tr><th>CONTA/BANCO</th><th>AÇÕES</th></tr></thead>
      <tbody id="tbodyContas"></tbody>
    </table>
  </div>
</div>

<!-- MODAL: REGISTRAR -->
<div class="modal-backdrop" id="modalPagamentoBackdrop">
  <div class="modal">
    <h2 id="modalTitulo">REGISTRAR</h2>
    <label>DATA</label>
    <input id="pagtoData" type="date" />
    <label>STATUS</label>
    <select id="pagtoStatus">
      <option value="pago">PAGO/RECEBIDO</option>
      <option value="pendente">PENDENTE</option>
    </select>
    <div class="actions">
      <button class="btn warn" id="btnCancelarPagto">CANCELAR</button>
      <button class="btn success" id="btnSalvarPagto">SALVAR</button>
    </div>
    <input type="hidden" id="pagtoIndex" />
    <input type="hidden" id="pagtoTipo" />
  </div>
</div>

<script>
/* ===== ESTADO ===== */
let despesas = JSON.parse(localStorage.getItem("despesas") || "[]");
let receitas = JSON.parse(localStorage.getItem("receitas") || "[]");
let categorias = JSON.parse(localStorage.getItem("categorias") || "[]");
let contas = JSON.parse(localStorage.getItem("contas") || "[]");
let userName = localStorage.getItem("userName") || "";
if (categorias.length === 0) { categorias = ["ENERGIA","INTERNET","ALUGUEL","MERCADO"]; }
if (contas.length === 0) { contas = ["ITAÚ","CAIXA","SANTANDER","BRADESCO"]; }

/* ===== UTIL ===== */
function toUpper(str){ return (str||"").toString().toUpperCase(); }
function formatDateBR(dateStr){ if(!dateStr) return "-"; const [yyyy,mm,dd] = String(dateStr).split("-"); return `${dd}/${mm}/${yyyy}`; }
function parseValorBR(text){ if(!text) return 0; return parseFloat(String(text).replace(/\./g,"").replace(",", ".")) || 0; }
function formatValorBR(valor){ return "R$ " + Number(valor).toLocaleString("pt-BR",{minimumFractionDigits:2}); }
function betweenDates(xDate, start, end){
  const d = new Date(xDate); d.setHours(0,0,0,0);
  const s = new Date(start); s.setHours(0,0,0,0);
  const e = new Date(end); e.setHours(23,59,59,999);
  return d >= s && d <= e;
}
function diaSemanaExtenso(dateStr){
  const dias = ["DOMINGO","SEGUNDA-FEIRA","TERÇA-FEIRA","QUARTA-FEIRA","QUINTA-FEIRA","SEXTA-FEIRA","SÁBADO"];
  const d = new Date(dateStr);
  return dias[d.getDay()];
}
function statusClassFor(item){
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const venc = new Date(item.data); venc.setHours(0,0,0,0);
  const isPago = (item.tipo === "RECEITA" ? item.status === "RECEBIDO" : item.status === "PAGO");
  const dias = (venc - hoje)/(1000*60*60*24);
  if(isPago) return { chip:"pago", row:"row-pago" };
  if(venc < hoje) return { chip:"vencido", row:"row-vencido" };
  if(dias > 0 && dias <= 3) return { chip:"avencer", row:"row-avencer" };
  return { chip:"pendente", row:"row-pendente" };
}

/* ===== USER ===== */
function renderUser(){
  document.getElementById("userName").value = userName;
  document.getElementById("userSaved").innerText = userName ? `LOGADO: ${userName}` : "";
}
document.getElementById("btnSalvarUser").addEventListener("click", ()=>{
  userName = toUpper(document.getElementById("userName").value.trim());
  localStorage.setItem("userName", userName);
  renderUser();
});

/* ===== Navegação ===== */
function activatePage(id){
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav button").forEach(b => {
    b.classList.toggle("active", b.getAttribute("data-page") === id);
  });
  render();
}
document.querySelectorAll("nav button").forEach(btn=>{
  btn.addEventListener("click", ()=> activatePage(btn.getAttribute("data-page")));
});

/* ===== Caixa alta ===== */
function enforceUppercaseInputs(){
  ["descReceita","valorReceita","descDespesa","valorDespesa","nomeCategoria","nomeConta"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", ()=> el.value = toUpper(el.value));
  });
}

/* ===== Selects ===== */
function fillCategorySelects(){
  const relCat = document.getElementById("relCategoria");
  relCat.innerHTML = '<option value="">TODAS</option>' + categorias.map(c=>`<option value="${c}">${c}</option>`).join("");

  document.getElementById("catReceita").innerHTML = categorias.map(c=>`<option value="${c}">${c}</option>`).join("");
  document.getElementById("catDespesa").innerHTML = categorias.map(c=>`<option value="${c}">${c}</option>`).join("");

  document.getElementById("contaReceita").innerHTML = contas.map(c=>`<option value="${c}">${c}</option>`).join("");
  document.getElementById("contaDespesa").innerHTML = contas.map(c=>`<option value="${c}">${c}</option>`).join("");
}

/* ===== Recorrentes: gerar para mês (receitas e despesas) ===== */
function gerarRecorrentesParaMes(inicioISO){
  const alvoAnoMes = inicioISO.slice(0,7);

  // Despesas
  const novasDespesas = [];
  despesas.forEach(d=>{
    if(String(d.recorrente) === "true"){
      const data = new Date(d.data);
      const novaData = new Date(data.getFullYear(), data.getMonth()+1, data.getDate());
      const novaAnoMes = novaData.toISOString().slice(0,7);
      if(novaAnoMes === alvoAnoMes){
        const nova = {
          descricao: d.descricao, categoria: d.categoria, conta: d.conta,
          valor: Number(d.valor||0), data: novaData.toISOString().slice(0,10),
          status: "PENDENTE", pagamento: null, recorrente: "true", boleto: null
        };
        if(!despesas.find(x=>x.descricao === nova.descricao && x.data === nova.data)){
          novasDespesas.push(nova);
        }
      }
    }
  });
  if(novasDespesas.length){
    despesas = [...despesas, ...novasDespesas];
    localStorage.setItem("despesas", JSON.stringify(despesas));
  }

  // Receitas
  const novasReceitas = [];
  receitas.forEach(r=>{
    if(String(r.recorrente) === "true"){
      const data = new Date(r.data);
      const novaData = new Date(data.getFullYear(), data.getMonth()+1, data.getDate());
      const novaAnoMes = novaData.toISOString().slice(0,7);
      if(novaAnoMes === alvoAnoMes){
        const nova = {
          descricao: r.descricao, categoria: r.categoria, conta: r.conta,
          valor: Number(r.valor||0), data: novaData.toISOString().slice(0,10),
          status: "PENDENTE", pagamento: null, recorrente: "true"
        };
        if(!receitas.find(x=>x.descricao === nova.descricao && x.data === nova.data)){
          novasReceitas.push(nova);
        }
      }
    }
  });
  if(novasReceitas.length){
    receitas = [...receitas, ...novasReceitas];
    localStorage.setItem("receitas", JSON.stringify(receitas));
  }
}

/* ===== Período (Dashboard e Relatórios) ===== */
function getPeriodoFiltro(tipoSel, campos){
  const hoje = new Date(); hoje.setHours(0,0,0,0);

  if(tipoSel === "dia"){
    const d = campos.dia.value || hoje.toISOString().slice(0,10);
    return { tipo:"dia", inicio: d, fim: d };
  }

  if(tipoSel === "semana"){
    const ini = campos.semanaIni.value;
    const fim = campos.semanaFim.value;
    if(!ini || !fim){
      const day = hoje.getDay(); // 0=dom
      const diffToMonday = (day === 0 ? -6 : 1 - day);
      const inicio = new Date(hoje); inicio.setDate(hoje.getDate()+diffToMonday);
      const fimDt = new Date(inicio); fimDt.setDate(inicio.getDate()+6);
      return { tipo:"semana", inicio: inicio.toISOString().slice(0,10), fim: fimDt.toISOString().slice(0,10) };
    }
    return { tipo:"semana", inicio: ini, fim: fim };
  }

  if(tipoSel === "mes"){
    const val = campos.mes.value || hoje.toISOString().slice(0,7);
    const [y,m] = val.split("-");
    const inicio = `${y}-${m}-01`;
    const fim = new Date(Number(y), Number(m), 0).toISOString().slice(0,10);
    return { tipo:"mes", inicio, fim };
  }

  if(tipoSel === "ano"){
    const y = campos.ano.value || String(hoje.getFullYear());
    return { tipo:"ano", inicio: `${y}-01-01`, fim: `${y}-12-31` };
  }

  if(tipoSel === "intervalo"){
    const ini = campos.inicio.value || hoje.toISOString().slice(0,10);
    const fim = campos.fim.value || hoje.toISOString().slice(0,10);
    return { tipo:"intervalo", inicio: ini, fim: fim };
  }

  // fallback mês
  const val = campos.mes.value || hoje.toISOString().slice(0,7);
  const [y,m] = val.split("-");
  return { tipo:"mes", inicio: `${y}-${m}-01`, fim: new Date(Number(y), Number(m), 0).toISOString().slice(0,10) };
}

/* ===== Dashboard ===== */
function renderDashboard(){
  const tipo = document.getElementById("periodoSelect").value;
  const filtro = getPeriodoFiltro(tipo, {
    dia: document.getElementById("filtroData"),
    semanaIni: document.getElementById("filtroSemanaInicio"),
    semanaFim: document.getElementById("filtroSemanaFim"),
    mes: document.getElementById("filtroMes"),
    ano: document.getElementById("filtroAno"),
    inicio: document.getElementById("filtroIntervaloInicio"),
    fim: document.getElementById("filtroIntervaloFim")
  });

  if(filtro.tipo === "mes"){ gerarRecorrentesParaMes(filtro.inicio); }

  const recs = receitas.filter(r=>betweenDates(r.data, filtro.inicio, filtro.fim));
  const deps = despesas.filter(d=>betweenDates(d.data, filtro.inicio, filtro.fim));
  const totalReceitas = recs.reduce((s,r)=>s+Number(r.valor||0),0);
  const totalDespesas = deps.reduce((s,d)=>s+Number(d.valor||0),0);
  document.getElementById("kpiReceitas").innerText = formatValorBR(totalReceitas);
  document.getElementById("kpiDespesas").innerText = formatValorBR(totalDespesas);
  document.getElementById("kpiSaldo").innerText = formatValorBR(totalReceitas - totalDespesas);

  const recorrentesBase = [...recs, ...deps];
  const recorrentesPct = recorrentesBase.length ? Math.round((recorrentesBase.filter(x=>String(x.recorrente) === "true").length/recorrentesBase.length)*100) : 0;
  document.getElementById("kpiRecorrentes").innerText = recorrentesPct + "%";

  // Contas do dia
  const hojeStr = (document.getElementById("filtroData").value || new Date().toISOString().slice(0,10));
  const diaExtenso = diaSemanaExtenso(hojeStr);
  const dataFormatada = formatDateBR(hojeStr);
  document.getElementById("tituloContasDia").innerText = `CONTAS DO DIA - ${diaExtenso} ${dataFormatada}`;

  const diaList = [
    ...receitas.filter(r=>r.data === hojeStr).map(r=>({tipo:"RECEITA", ...r})),
    ...despesas.filter(d=>d.data === hojeStr).map(d=>({tipo:"DESPESA", ...d}))
  ];
  const diaTotal = diaList.reduce((s,x)=>s+Number(x.valor||0),0);
  document.getElementById("totalDia").innerText = formatValorBR(diaTotal);
  document.getElementById("tbodyDia").innerHTML = diaList.map(x=>{
    const sc = statusClassFor(x);
    return `
      <tr class="${sc.row}">
        <td>${x.tipo}</td>
        <td>${toUpper(x.descricao)}</td>
        <td>${toUpper(x.categoria || "-")}</td>
        <td>${toUpper(x.conta || "-")}</td>
        <td>${formatValorBR(x.valor)}</td>
        <td>${formatDateBR(x.data)}</td>
        <td><span class="chip ${sc.chip}">${toUpper(x.status)}</span></td>
      </tr>
    `;
  }).join("");

  // Período separado
  document.getElementById("subtotalReceitas").innerText = formatValorBR(totalReceitas);
  document.getElementById("subtotalDespesas").innerText = formatValorBR(totalDespesas);
  document.getElementById("totalPeriodo").innerText = formatValorBR(totalReceitas + totalDespesas);

  document.getElementById("tbodyPeriodoReceitas").innerHTML = recs.map(r=>{
    const sc = statusClassFor({tipo:"RECEITA", ...r});
    return `
      <tr class="${sc.row}">
        <td>${toUpper(r.descricao)}</td>
        <td>${toUpper(r.categoria || "-")}</td>
        <td>${toUpper(r.conta || "-")}</td>
        <td>${formatValorBR(r.valor)}</td>
        <td>${formatDateBR(r.data)}</td>
        <td><span class="chip ${sc.chip}">${toUpper(r.status)}</span></td>
      </tr>
    `;
  }).join("");

  document.getElementById("tbodyPeriodoDespesas").innerHTML = deps.map(d=>{
    const sc = statusClassFor({tipo:"DESPESA", ...d});
    return `
      <tr class="${sc.row}">
        <td>${toUpper(d.descricao)}</td>
        <td>${toUpper(d.categoria || "-")}</td>
        <td>${toUpper(d.conta || "-")}</td>
        <td>${formatValorBR(d.valor)}</td>
        <td>${formatDateBR(d.data)}</td>
        <td><span class="chip ${sc.chip}">${toUpper(d.status)}</span></td>
      </tr>
    `;
  }).join("");
}

/* ===== Tabelas ===== */
function renderReceitas(){
  document.getElementById("tbodyReceitas").innerHTML = receitas.map((r,i)=>{
    const sc = statusClassFor({tipo:"RECEITA", ...r});
    return `
      <tr data-index="${i}" class="${sc.row}">
        <td>${toUpper(r.descricao)}</td>
        <td>${toUpper(r.categoria || "-")}</td>
        <td>${toUpper(r.conta || "-")}</td>
        <td>${formatValorBR(r.valor)}</td>
        <td>${formatDateBR(r.data)}</td>
        <td><span class="chip ${sc.chip}">${toUpper(r.status)}</span></td>
        <td>${r.pagamento ? formatDateBR(r.pagamento) : "-"}</td>
        <td class="actions">
          <button class="btn warn" data-action="edit-receita">EDITAR</button>
          <button class="btn danger" data-action="del-receita">EXCLUIR</button>
          <button class="btn success" data-action="pay-receita">REGISTRAR RECEITA</button>
        </td>
      </tr>
    `;
  }).join("");
}

function renderDespesas(){
  document.getElementById("tbodyDespesas").innerHTML = despesas.map((d,i)=>{
    const sc = statusClassFor({tipo:"DESPESA", ...d});
    return `
      <tr data-index="${i}" class="${sc.row}">
        <td>${toUpper(d.descricao)}</td>
        <td>${toUpper(d.categoria || "-")}</td>
        <td>${toUpper(d.conta || "-")}</td>
        <td>${formatValorBR(d.valor)}</td>
        <td>${formatDateBR(d.data)}</td>
        <td><span class="chip ${sc.chip}">${toUpper(d.status)}</span></td>
        <td>${d.pagamento ? formatDateBR(d.pagamento) : "-"}</td>
        <td>${String(d.recorrente) === "true" ? "SIM" : "NÃO"}</td>
        <td>${d.boleto ? `<a href="${d.boleto}" target="_blank" rel="noopener">VER BOLETO</a>` : "-"}</td>
        <td class="actions">
          <button class="btn warn" data-action="edit-despesa">EDITAR</button>
          <button class="btn danger" data-action="del-despesa">EXCLUIR</button>
          <button class="btn success" data-action="pay-despesa">REGISTRAR PAGAMENTO</button>
        </td>
      </tr>
    `;
  }).join("");
}

/* ===== RELATÓRIOS ===== */
function getRelatorioFiltro(){
  const tipo = document.getElementById("relPeriodoTipo").value;
  const filtro = getPeriodoFiltro(tipo, {
    dia: document.getElementById("relDia"),
    semanaIni: document.getElementById("relInicio"),
    semanaFim: document.getElementById("relFim"),
    mes: document.getElementById("relMes"),
    ano: document.getElementById("relAno"),
    inicio: document.getElementById("relInicio"),
    fim: document.getElementById("relFim")
  });
  const cat = document.getElementById("relCategoria").value;
  const tipoDado = document.getElementById("relTipoDado").value;
  return { ...filtro, cat, tipoDado };
}

function renderRelatorioDados(){
  const f = getRelatorioFiltro();
  let recs = receitas.filter(r=>betweenDates(r.data, f.inicio, f.fim));
  let deps = despesas.filter(d=>betweenDates(d.data, f.inicio, f.fim));
  if(f.cat) { recs = recs.filter(r=>r.categoria === f.cat); deps = deps.filter(d=>d.categoria === f.cat); }
  if(f.tipoDado === "receitas") deps = [];
  if(f.tipoDado === "despesas") recs = [];

  document.getElementById("relReceitasBody").innerHTML = recs.map(r=>{
    const sc = statusClassFor({tipo:"RECEITA", ...r});
    return `<tr class="${sc.row}">
      <td>${toUpper(r.descricao)}</td><td>${toUpper(r.categoria || "-")}</td><td>${toUpper(r.conta || "-")}</td>
      <td>${formatValorBR(r.valor)}</td><td>${formatDateBR(r.data)}</td><td><span class="chip ${sc.chip}">${toUpper(r.status)}</span></td>
    </tr>`;
  }).join("");

  document.getElementById("relDespesasBody").innerHTML = deps.map(d=>{
    const sc = statusClassFor({tipo:"DESPESA", ...d});
    return `<tr class="${sc.row}">
      <td>${toUpper(d.descricao)}</td><td>${toUpper(d.categoria || "-")}</td><td>${toUpper(d.conta || "-")}</td>
      <td>${formatValorBR(d.valor)}</td><td>${formatDateBR(d.data)}</td><td><span class="chip ${sc.chip}">${toUpper(d.status)}</span></td>
    </tr>`;
  }).join("");

  const totalR = recs.reduce((s,r)=>s+Number(r.valor||0),0);
  const totalD = deps.reduce((s,d)=>s+Number(d.valor||0),0);
  document.getElementById("relReceitasTotal").innerText = formatValorBR(totalR);
  document.getElementById("relDespesasTotal").innerText = formatValorBR(totalD);
  document.getElementById("relTotalReceitas").innerText = formatValorBR(totalR);
  document.getElementById("relTotalDespesas").innerText = formatValorBR(totalD);
  document.getElementById("relSaldo").innerText = formatValorBR(totalR - totalD);

  const porCat = {};
  [...recs, ...deps].forEach(x=>{
    const c = toUpper(x.categoria || "SEM CATEGORIA");
    porCat[c] = (porCat[c]||0) + Number(x.valor||0);
  });
  document.getElementById("relAnaliseCatBody").innerHTML =
    Object.entries(porCat).map(([cat,total])=>`<tr><td>${cat}</td><td>${formatValorBR(total)}</td></tr>`).join("");
}

/* ===== Exportação PDF ===== */
function exportarPDF(){
  const conteudo = document.getElementById("relatorios").innerHTML;
  const janela = window.open("", "", "width=900,height=700");
  janela.document.write(`
<html>
<head>
<title>RELATÓRIO FINANCEIRO</title>
<style>
@page { size: A4 portrait; margin: 12mm; }
body { font-family: Arial, sans-serif; text-transform: uppercase; color:#111827; }
h1,h2 { text-align:center; margin: 6px 0; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border: 1px solid #000; padding:6px; font-size:12px; text-align:left; }
.card { border: 1px solid #000; border-radius:6px; padding:10px; margin:6px; }
#relTotalReceitas { color:#2563eb; }
#relTotalDespesas { color:#ef4444; }
#relSaldo { color:#16a34a; }
</style>
</head>
<body>
<h1>RELATÓRIO FINANCEIRO</h1>
${conteudo}
</body>
</html>
  `);
  janela.document.close();
  janela.focus();
  janela.print();
}

/* ===== Persistência e render ===== */
function persist(){
  localStorage.setItem("despesas", JSON.stringify(despesas));
  localStorage.setItem("receitas", JSON.stringify(receitas));
  localStorage.setItem("categorias", JSON.stringify(categorias));
  localStorage.setItem("contas", JSON.stringify(contas));
  localStorage.setItem("userName", userName);
}
function render(){
  persist();
  renderUser();
  fillCategorySelects();
  renderDashboard();
  renderReceitas();
  renderDespesas();
  renderRelatorioDados();
}

/* ===== CRUD: Receitas ===== */
document.getElementById("btnSalvarReceita").addEventListener("click", ()=>{
  const idx = document.getElementById("editIndexReceita").value;
  const receita = {
    descricao: toUpper(document.getElementById("descReceita").value.trim()),
    categoria: toUpper(document.getElementById("catReceita").value),
    conta: toUpper(document.getElementById("contaReceita").value),
    valor: parseValorBR(document.getElementById("valorReceita").value.trim()),
    data: document.getElementById("dataReceita").value,
    status: toUpper(document.getElementById("statusReceita").value),
    pagamento: document.getElementById("dataPagtoReceita").value || null,
    recorrente: document.getElementById("recorrenteReceita").value // "true"/"false"
  };
  if(!receita.descricao || !receita.valor || !receita.data){ alert("PREENCHA DESCRIÇÃO, VALOR E DATA."); return; }
  if(idx){ receitas[parseInt(idx,10)] = receita; } else { receitas.push(receita); }
  document.getElementById("formReceita").reset();
  document.getElementById("editIndexReceita").value = "";
  render();
});

document.getElementById("tbodyReceitas").addEventListener("click",(e)=>{
  const btn = e.target.closest("button"); if(!btn) return;
  const tr = btn.closest("tr"); const idx = parseInt(tr.getAttribute("data-index"),10);
  if(btn.dataset.action === "edit-receita"){
    const r = receitas[idx];
    document.getElementById("descReceita").value = r.descricao;
    document.getElementById("catReceita").value = r.categoria || categorias[0];
    document.getElementById("contaReceita").value = r.conta || contas[0];
    document.getElementById("valorReceita").value = Number(r.valor).toLocaleString("pt-BR",{minimumFractionDigits:2});
    document.getElementById("dataReceita").value = r.data;
    document.getElementById("statusReceita").value = r.status.toLowerCase() === "recebido" ? "recebido" : "pendente";
    document.getElementById("dataPagtoReceita").value = r.pagamento || "";
    document.getElementById("recorrenteReceita").value = String(r.recorrente) === "true" ? "true" : "false";
    document.getElementById("editIndexReceita").value = idx;
    activatePage("receitas");
  } else if(btn.dataset.action === "del-receita"){
    if(confirm("EXCLUIR ESTA RECEITA?")){
      receitas.splice(idx,1);
      render();
    }
  } else if(btn.dataset.action === "pay-receita"){
    openPagamentoModal("receita", idx, "REGISTRAR RECEITA");
  }
});

/* ===== CRUD: Despesas ===== */
document.getElementById("btnSalvarDespesa").addEventListener("click", ()=>{
  const idx = document.getElementById("editIndexDespesa").value;
  const file = document.getElementById("boletoDespesa").files[0];
  const base = {
    descricao: toUpper(document.getElementById("descDespesa").value.trim()),
    categoria: toUpper(document.getElementById("catDespesa").value),
    conta: toUpper(document.getElementById("contaDespesa").value),
    valor: parseValorBR(document.getElementById("valorDespesa").value.trim()),
    data: document.getElementById("dataDespesa").value,
    status: toUpper(document.getElementById("statusDespesa").value),
    pagamento: document.getElementById("dataPagtoDespesa").value || null,
    recorrente: document.getElementById("recorrenteDespesa").value // "true"/"false"
  };
  if(!base.descricao || !base.valor || !base.data){ alert("PREENCHA DESCRIÇÃO, VALOR E VENCIMENTO."); return; }

  const finalize = (boletoDataUrl)=>{
    const despesa = { ...base, boleto: boletoDataUrl || (idx ? despesas[parseInt(idx,10)].boleto : null) };
    if(idx){ despesas[parseInt(idx,10)] = despesa; } else { despesas.push(despesa); }
    document.getElementById("formDespesa").reset();
    document.getElementById("editIndexDespesa").value = "";
    render();
  };

  if(file){
    const reader = new FileReader();
    reader.onload = ()=> finalize(reader.result);
    reader.onerror = ()=> { alert("FALHA AO ANEXAR BOLETO."); finalize(null); };
    reader.readAsDataURL(file);
  } else {
    finalize(null);
  }
});

document.getElementById("tbodyDespesas").addEventListener("click",(e)=>{
  const btn = e.target.closest("button"); if(!btn) return;
  const tr = btn.closest("tr"); const idx = parseInt(tr.getAttribute("data-index"),10);
  if(btn.dataset.action === "edit-despesa"){
    const d = despesas[idx];
    document.getElementById("descDespesa").value = d.descricao;
    document.getElementById("catDespesa").value = d.categoria || categorias[0];
    document.getElementById("contaDespesa").value = d.conta || contas[0];
    document.getElementById("valorDespesa").value = Number(d.valor).toLocaleString("pt-BR",{minimumFractionDigits:2});
    document.getElementById("dataDespesa").value = d.data;
    document.getElementById("statusDespesa").value = d.status.toLowerCase() === "pago" ? "pago" : "pendente";
    document.getElementById("dataPagtoDespesa").value = d.pagamento || "";
    document.getElementById("recorrenteDespesa").value = String(d.recorrente) === "true" ? "true" : "false";
    document.getElementById("editIndexDespesa").value = idx;
    activatePage("despesas");
  } else if(btn.dataset.action === "del-despesa"){
    if(confirm("EXCLUIR ESTA DESPESA?")){
      despesas.splice(idx,1);
      render();
    }
  } else if(btn.dataset.action === "pay-despesa"){
    openPagamentoModal("despesa", idx, "REGISTRAR PAGAMENTO");
  }
});

/* ===== Categorias ===== */
function renderCategorias(){
  document.getElementById("tbodyCategorias").innerHTML = categorias.map((c,i)=>`
    <tr data-index="${i}">
      <td>${toUpper(c)}</td>
      <td class="actions">
        <button class="btn warn" data-action="edit-cat">EDITAR</button>
        <button class="btn danger" data-action="del-cat">EXCLUIR</button>
      </td>
    </tr>
  `).join("");
  fillCategorySelects();
  localStorage.setItem("categorias", JSON.stringify(categorias));
}
document.getElementById("btnSalvarCategoria").addEventListener("click", ()=>{
  const idx = document.getElementById("editIndexCategoria").value;
  const nome = toUpper(document.getElementById("nomeCategoria").value.trim());
  if(!nome){ alert("DIGITE UMA CATEGORIA."); return; }
  if(idx){ categorias[parseInt(idx,10)] = nome; }
  else { categorias.push(nome); }
  document.getElementById("formCategoria").reset();
  document.getElementById("editIndexCategoria").value = "";
  renderCategorias(); render();
});
document.getElementById("tbodyCategorias").addEventListener("click",(e)=>{
  const btn = e.target.closest("button"); if(!btn) return;
  const tr = btn.closest("tr"); const idx = parseInt(tr.getAttribute("data-index"),10);
  if(btn.dataset.action === "edit-cat"){
    document.getElementById("nomeCategoria").value = categorias[idx];
    document.getElementById("editIndexCategoria").value = idx;
  } else if(btn.dataset.action === "del-cat"){
    if(confirm("EXCLUIR ESTA CATEGORIA?")){
      categorias.splice(idx,1);
      renderCategorias(); render();
    }
  }
});

/* ===== Contas (bancos/IFs) ===== */
function renderContas(){
  document.getElementById("tbodyContas").innerHTML = contas.map((c,i)=>`
    <tr data-index="${i}">
      <td>${toUpper(c)}</td>
      <td class="actions">
        <button class="btn warn" data-action="edit-conta">EDITAR</button>
        <button class="btn danger" data-action="del-conta">EXCLUIR</button>
      </td>
    </tr>
  `).join("");
  fillCategorySelects();
  localStorage.setItem("contas", JSON.stringify(contas));
}
document.getElementById("btnSalvarConta").addEventListener("click", ()=>{
  const idx = document.getElementById("editIndexConta").value;
  const nome = toUpper(document.getElementById("nomeConta").value.trim());
  if(!nome){ alert("DIGITE UMA CONTA/BANCO."); return; }
  if(idx){ contas[parseInt(idx,10)] = nome; }
  else { contas.push(nome); }
  document.getElementById("formConta").reset();
  document.getElementById("editIndexConta").value = "";
  renderContas(); render();
});
document.getElementById("tbodyContas").addEventListener("click",(e)=>{
  const btn = e.target.closest("button"); if(!btn) return;
  const tr = btn.closest("tr"); const idx = parseInt(tr.getAttribute("data-index"),10);
  if(btn.dataset.action === "edit-conta"){
    document.getElementById("nomeConta").value = contas[idx];
    document.getElementById("editIndexConta").value = idx;
  } else if(btn.dataset.action === "del-conta"){
    if(confirm("EXCLUIR ESTA CONTA/BANCO?")){
      contas.splice(idx,1);
      renderContas(); render();
    }
  }
});

/* ===== Modal ===== */
function openPagamentoModal(tipo, idx, titulo){
  document.getElementById("pagtoTipo").value = tipo; // "receita" ou "despesa"
  document.getElementById("pagtoIndex").value = String(idx);
  document.getElementById("modalTitulo").innerText = titulo || "REGISTRAR";
  const hojeISO = new Date().toISOString().slice(0,10);
  document.getElementById("pagtoStatus").value = "pago";
  document.getElementById("pagtoData").value = hojeISO;
  document.getElementById("modalPagamentoBackdrop").style.display = "flex";
}
function closePagamentoModal(){
  document.getElementById("modalPagamentoBackdrop").style.display = "none";
  document.getElementById("pagtoIndex").value = "";
  document.getElementById("pagtoTipo").value = "";
  document.getElementById("pagtoData").value = "";
  document.getElementById("pagtoStatus").value = "pago";
}
document.getElementById("btnCancelarPagto").addEventListener("click", closePagamentoModal);
document.getElementById("btnSalvarPagto").addEventListener("click", ()=>{
  const tipo = document.getElementById("pagtoTipo").value;
  const idx = parseInt(document.getElementById("pagtoIndex").value,10);
  const data = document.getElementById("pagtoData").value;
  const status = document.getElementById("pagtoStatus").value;
  if(status === "pago" && !data){ alert("INFORME A DATA."); return; }

  if(tipo === "receita"){
    receitas[idx].status = status === "pago" ? "RECEBIDO" : "PENDENTE";
    receitas[idx].pagamento = status === "pago" ? data : null;
  } else if(tipo === "despesa"){
    despesas[idx].status = status === "pago" ? "PAGO" : "PENDENTE";
    despesas[idx].pagamento = status === "pago" ? data : null;
  }

  persist(); closePagamentoModal(); render();
});

/* ===== Inicialização ===== */
enforceUppercaseInputs();
renderCategorias();
renderContas();
render();

document.getElementById("periodoSelect").addEventListener("change", renderDashboard);
document.getElementById("filtroData").addEventListener("change", renderDashboard);
document.getElementById("filtroSemanaInicio").addEventListener("change", renderDashboard);
document.getElementById("filtroSemanaFim").addEventListener("change", renderDashboard);
document.getElementById("filtroMes").addEventListener("change", renderDashboard);
document.getElementById("filtroAno").addEventListener("input", renderDashboard);
document.getElementById("filtroIntervaloInicio").addEventListener("change", renderDashboard);
document.getElementById("filtroIntervaloFim").addEventListener("change", renderDashboard);

document.getElementById("btnPesquisarDashboard").addEventListener("click", renderDashboard);
document.getElementById("btnLimparDashboard").addEventListener("click", ()=>{
  document.getElementById("periodoSelect").value = "mes";
  document.getElementById("filtroData").value = "";
  document.getElementById("filtroSemanaInicio").value = "";
  document.getElementById("filtroSemanaFim").value = "";
  document.getElementById("filtroMes").value = "";
  document.getElementById("filtroAno").value = "";
  document.getElementById("filtroIntervaloInicio").value = "";
  document.getElementById("filtroIntervaloFim").value = "";
  renderDashboard();
});

document.getElementById("btnGerarRelatorio").addEventListener("click", renderRelatorioDados);
document.getElementById("btnExportarPDF").addEventListener("click", exportarPDF);
</script>
</body>
</html>